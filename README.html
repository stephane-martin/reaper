<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>reaper</title>
  <style type="text/css">
.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";font-size:16px;line-height:1.5;word-wrap:break-word;box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto;padding:45px}.markdown-body a{color:#0366d6;background-color:transparent;text-decoration:none;-webkit-text-decoration-skip:objects}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body a:hover{text-decoration:underline}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body strong{font-weight:600}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em;margin:.67em 0;padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{padding-bottom:.3em;font-size:1.5em;border-bottom:1px solid #eaecef}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body img{border-style:none}.markdown-body svg:not(:root){overflow:hidden}.markdown-body hr{box-sizing:content-box;height:.25em;margin:24px 0;padding:0;overflow:hidden;background-color:#e1e4e8;border:0}.markdown-body hr::before{display:table;content:""}.markdown-body hr::after{display:table;clear:both;content:""}.markdown-body input{margin:0;overflow:visible;font:inherit;font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body li>p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dd{margin-left:0}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body code{font-family:SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace}.markdown-body pre{font:12px SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace;word-wrap:normal}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body table{display:block;width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body code{padding:.2em 0;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code::after,.markdown-body code::before{letter-spacing:-.2em;content:"\00a0"}.markdown-body pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:0 0;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}.markdown-body pre code::after,.markdown-body pre code::before{content:normal}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body kbd{box-shadow:inset 0 -1px 0 #959da5;display:inline-block;padding:3px 5px;font:11px/10px SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace;color:#444d56;vertical-align:middle;background-color:#fcfcfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}.markdown-body::before{display:table;content:""}.markdown-body::after{display:table;clear:both;content:""}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.Alert,.Error,.Note,.Success,.Warning{padding:11px;margin-bottom:24px;border-style:solid;border-width:1px;border-radius:4px}.Alert p,.Error p,.Note p,.Success p,.Warning p{margin-top:0}.Alert p:last-child,.Error p:last-child,.Note p:last-child,.Success p:last-child,.Warning p:last-child{margin-bottom:0}.Alert{color:#246;background-color:#e2eef9;border-color:#bac6d3}.Warning{color:#4c4a42;background-color:#fff9ea;border-color:#dfd8c2}.Error{color:#911;background-color:#fcdede;border-color:#d2b2b2}.Success{color:#22662c;background-color:#e2f9e5;border-color:#bad3be}.Note{color:#2f363d;background-color:#f6f8fa;border-color:#d5d8da}.Alert h1,.Alert h2,.Alert h3,.Alert h4,.Alert h5,.Alert h6{color:#246;margin-bottom:0}.Warning h1,.Warning h2,.Warning h3,.Warning h4,.Warning h5,.Warning h6{color:#4c4a42;margin-bottom:0}.Error h1,.Error h2,.Error h3,.Error h4,.Error h5,.Error h6{color:#911;margin-bottom:0}.Success h1,.Success h2,.Success h3,.Success h4,.Success h5,.Success h6{color:#22662c;margin-bottom:0}.Note h1,.Note h2,.Note h3,.Note h4,.Note h5,.Note h6{color:#2f363d;margin-bottom:0}.Alert h1:first-child,.Alert h2:first-child,.Alert h3:first-child,.Alert h4:first-child,.Alert h5:first-child,.Alert h6:first-child,.Error h1:first-child,.Error h2:first-child,.Error h3:first-child,.Error h4:first-child,.Error h5:first-child,.Error h6:first-child,.Note h1:first-child,.Note h2:first-child,.Note h3:first-child,.Note h4:first-child,.Note h5:first-child,.Note h6:first-child,.Success h1:first-child,.Success h2:first-child,.Success h3:first-child,.Success h4:first-child,.Success h5:first-child,.Success h6:first-child,.Warning h1:first-child,.Warning h2:first-child,.Warning h3:first-child,.Warning h4:first-child,.Warning h5:first-child,.Warning h6:first-child{margin-top:0}h1.title,p.subtitle{text-align:center}h1.title.followed-by-subtitle{margin-bottom:0}p.subtitle{font-size:1.5em;font-weight:600;line-height:1.25;margin-top:0;margin-bottom:16px;padding-bottom:.3em}div.line-block{white-space:pre-line}
  </style>
  <style type="text/css">code{white-space: pre;}</style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<article class="markdown-body">
<header>
<h1 class="title">reaper</h1>
</header>
<hr>
<nav id="TOC">
<h1 class="toc-title">Contents</h1>
<ul>
<li><a href="#features"><span class="toc-section-number">1</span> Features</a></li>
<li><a href="#project-status"><span class="toc-section-number">2</span> Project status</a></li>
<li><a href="#getting-started"><span class="toc-section-number">3</span> Getting Started</a><ul>
<li><a href="#install"><span class="toc-section-number">3.1</span> Install</a></li>
<li><a href="#configure"><span class="toc-section-number">3.2</span> Configure</a></li>
<li><a href="#inline-help"><span class="toc-section-number">3.3</span> Inline help</a></li>
<li><a href="#use-reaper"><span class="toc-section-number">3.4</span> Use reaper</a><ul>
<li><a href="#listen-for-access-log-entries"><span class="toc-section-number">3.4.1</span> Listen for access log entries</a></li>
<li><a href="#configure-access-logs-format"><span class="toc-section-number">3.4.2</span> Configure access logs format</a></li>
<li><a href="#filter-access-logs"><span class="toc-section-number">3.4.3</span> Filter access logs</a></li>
<li><a href="#forward-access-logs"><span class="toc-section-number">3.4.4</span> Forward access logs</a></li>
<li><a href="#http-api"><span class="toc-section-number">3.4.5</span> HTTP API</a></li>
<li><a href="#websocket-api"><span class="toc-section-number">3.4.6</span> Websocket API</a></li>
<li><a href="#logging"><span class="toc-section-number">3.4.7</span> Logging</a></li>
</ul></li>
</ul></li>
<li><a href="#design"><span class="toc-section-number">4</span> Design</a></li>
<li><a href="#changelog"><span class="toc-section-number">5</span> Changelog</a></li>
</ul>
</nav>
<hr>
<p><code>reaper</code> is a simple tool to collect access logs from web servers and publish the logs to an external message queue.</p>
<pre><code>                                                           ,,,,,          ,,,,,         
                                                         ,,,,,,,,,     ,,,,,,,,,,       
                                                        ,,,,,,,,,,,,  ,,,,,,,,,,,,   
                                                       ,,,,,,,,,,,,,,,,,,,,,,,,,,,,    
                         ##                           ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,, 
                      ####                           ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,    
                    #####                            ,,,@@@@@*,,,,,,,,,,,,,,,@@@@@,,,  
                  ######                            ,,,,,#@@@@@&amp;,,,,,,,,,,/@@@@@@,,,,     
                #######                             ,,,,,,,@@@@@@,,,,,,,,@@@@@@,,,,,,,    
             #########                              ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,    
            ##########                              ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,   
          ###########                               ,,,,,,,,,,,,,,,,(/,,,,,,,,,,,,,,,,    
         ###########                                ,,,,,,@,/@@,,@,,@@,,@,,@@*,@,,,,,,    
        ############                                 ,,,,,,@@@@@@&amp;@@@@@@@@@@@@@,,,,,,     
      #############                                   ,,,,,,,@@@@@@@@@@@@@@@@,,,,,,,      
     ##############                                      ,,,,@,@@@@@@@@@@@@,@,,,,        
    ##############                                          ,,,,@@,@@@@,@@,,*,           
    ##############                                           .,,,*,,@@,,/,,,             
   ###############                                             ,,,,,%#,,,,,             
  ###############                                               ,,,,,,,,,,               
  ###############                                               .,,,,,,,,                
 ################                                                                       
 ################                                                                        
 ################                                                                       
 ################                                            GIVE ME YOUR LOGS           
 ################                                                                        
  ##################                                                                      
   ##################                                                                     </code></pre>
<h1 id="features"><span class="header-section-number">1</span> Features</h1>
<ul>
<li>Collect log on TCP/UDP syslog</li>
<li>Syslog RFC3154 or RFC5424</li>
<li>Collect log on stdin</li>
<li>Parse logs formats: JSON, key/values, common, combined</li>
<li>Stream access logs with websocket</li>
<li>Download logs with HTTP</li>
<li>Filter out unwanted log lines (predicate in Javascript)</li>
<li>Can write collected logs to stdout, stderr, file</li>
<li>Can write collected logs to databases: PostgreSQL/TimescaleDB, Elasticsearch</li>
<li>Can write collected logs to message brokers: RabbitMQ, nsqd, STOMP enabled message broker</li>
<li>Can write collected logs to a distributed log: Kafka</li>
<li>Can write collected logs to a redis list</li>
<li>Can forward collected logs to another reaper instance</li>
<li>Should work on any *NIX</li>
</ul>
<h1 id="project-status"><span class="header-section-number">2</span> Project status</h1>
<p>Alpha. Version 0.1.0.</p>
<p>reaper is functional and be used in simple environments. But it lacks proper test cases and performance testing in busy environments.</p>
<h1 id="getting-started"><span class="header-section-number">3</span> Getting Started</h1>
<h2 id="install"><span class="header-section-number">3.1</span> Install</h2>
<ul>
<li><p>Binary releases</p>
<p>https://github.com/stephane-martin/reaper/releases</p>
<p>Just copy the binary in your PATH.</p></li>
<li><p>Compile from source</p>
<p>The Go compiler and <code>dep</code> (https://golang.github.io/dep) are required</p>
<p><code>git clone https://github.com/stephane-martin/reaper</code> in an appropriate folder (GOPATH...)</p>
<p><code>make debug</code> or <code>make release</code></p></li>
<li><p>Compile from source using Docker</p>
<p>If you can't install Golang and dep, you can also compile reaper using Docker</p>
<p><code>git clone https://github.com/stephane-martin/reaper</code></p>
<p><code>sudo make dockerbuild</code></p></li>
</ul>
<h2 id="configure"><span class="header-section-number">3.2</span> Configure</h2>
<p>Currently reaper does not use a configuration file. Arguments are passed on the command line or with environment variables.</p>
<h2 id="inline-help"><span class="header-section-number">3.3</span> Inline help</h2>
<p><code>reaper --help</code></p>
<p><code>reaper (command) --help</code></p>
<h2 id="use-reaper"><span class="header-section-number">3.4</span> Use reaper</h2>
<h3 id="listen-for-access-log-entries"><span class="header-section-number">3.4.1</span> Listen for access log entries</h3>
<h4 id="tcp-syslog"><span class="header-section-number">3.4.1.1</span> TCP syslog</h4>
<p>Start reaper with <code>--tcp 127.0.0.1:1514</code>. Here 127.0.0.1 is the listen address.</p>
<h4 id="udp-syslog"><span class="header-section-number">3.4.1.2</span> UDP syslog</h4>
<p>Start reaper with <code>--udp 127.0.0.1:1514</code>.</p>
<p>This can be used with nginx or caddy. In nginx.conf:</p>
<pre><code>access_log syslog:server=127.0.0.1:1514,facility=daemon,tag=nginxaccess,severity=info jrich;</code></pre>
<h4 id="syslog-protocol"><span class="header-section-number">3.4.1.3</span> Syslog protocol</h4>
<p>By default the syslog protocol is supposed to be RFC3164. Use the global flag '--rfc5424' to switch to RFC5424.</p>
<h4 id="stdin"><span class="header-section-number">3.4.1.4</span> stdin</h4>
<p>Start reaper with <code>--stdin</code>.</p>
<p>This can be used with Apache. For example in Apache configuration:</p>
<pre><code>CustomLog &quot;||/path/to/reaper --format combined --stdin&quot; combined</code></pre>
<h3 id="configure-access-logs-format"><span class="header-section-number">3.4.2</span> Configure access logs format</h3>
<p>reaper needs to know the format in which the web server writes access logs entries. Use the <code>--format</code> flag.</p>
<h4 id="json"><span class="header-section-number">3.4.2.1</span> JSON</h4>
<p><code>reaper --udp 127.0.0.1:1514 --format json</code></p>
<p>Example nginx configuration:</p>
<pre><code>log_format jrich escape=json
    '{'
        '&quot;timestamp&quot;:&quot;$time_iso8601&quot;,'
        '&quot;method&quot;:&quot;$request_method&quot;,'
        '&quot;scheme&quot;:&quot;$scheme&quot;,'
        '&quot;host&quot;:&quot;$host&quot;,'
        '&quot;server&quot;:&quot;$server_name&quot;,'
        '&quot;uri&quot;:&quot;$uri&quot;,'
        '&quot;duration&quot;:$request_time,'
        '&quot;length&quot;:$request_length,'
        '&quot;status&quot;:$status,'
        '&quot;sent&quot;:$bytes_sent,'
        '&quot;agent&quot;:&quot;$http_user_agent&quot;,'
        '&quot;remoteaddr&quot;:&quot;$remote_addr&quot;,'
        '&quot;remoteuser&quot;:&quot;$remote_user&quot;'
    '}';

access_log syslog:server=127.0.0.1:1514,facility=daemon,tag=nginxaccess,severity=info jrich;</code></pre>
<h4 id="keyvalues"><span class="header-section-number">3.4.2.2</span> Key/values</h4>
<p><code>reaper --udp 127.0.0.1:1514 --format kv</code></p>
<p>Example nginx configuration:</p>
<pre><code>log_format rich
    'remote_addr=&quot;$remote_addr&quot; remote_user=&quot;$remote_user&quot; time=&quot;$time_iso8601&quot; length=$request_length'
    ' host=&quot;$host&quot; request=&quot;$request_uri&quot; uri=&quot;$uri&quot; status=$status bytes_sent=$bytes_sent agent=&quot;$http_user_agent&quot;'
    ' duration=$request_time upstream_duration=$upstream_response_time method=&quot;$request_method&quot; scheme=&quot;$scheme&quot;'
    ' server=&quot;$server_name&quot;';</code></pre>
<h4 id="common-log-format"><span class="header-section-number">3.4.2.3</span> common log format</h4>
<p><code>reaper --udp 127.0.0.1:1514 --format common</code></p>
<h4 id="combined-log-format"><span class="header-section-number">3.4.2.4</span> combined log format</h4>
<p><code>reaper --udp 127.0.0.1:1514 --format combined</code></p>
<h3 id="filter-access-logs"><span class="header-section-number">3.4.3</span> Filter access logs</h3>
<p>The <code>--filterout EXPR</code> global flag can be set to specify a filter.</p>
<p>EXPR is a javascript expression that can use the log entry fields. If the EXPR is True, the entry is filtered out. Multiple --filterout flags can be used. In that case, an entry is filtered out if any of the expressions is True.</p>
<p>Example:</p>
<p><code>reaper --udp 127.0.0.1:1514 --format json --filterout 'host==&quot;example.org&quot;' stdout</code></p>
<p>Log entries for requests to http://example.org will be filtered out.</p>
<p>Please note that filtering is not free from a performance point of view. It uses an embedded Javascript engine.</p>
<h3 id="forward-access-logs"><span class="header-section-number">3.4.4</span> Forward access logs</h3>
<p>reaper can forward access logs to various destinations. The type of the destination is selected through a command on reaper command line, after the previous global flags.</p>
<p>When the destination is not reachable, log entries are buffered in the embedded nsqd instance. When the destination is reachable again, buffered entries will be forwarded. So you do not need to start the destination before reaper.</p>
<p>Each destination has specific flags to configure it.</p>
<h4 id="stdout-stderr"><span class="header-section-number">3.4.4.1</span> stdout, stderr</h4>
<ul>
<li><code>reaper --udp 127.0.0.1 stdout</code></li>
<li><code>reaper --udp 127.0.0.1 stderr</code></li>
</ul>
<h4 id="file"><span class="header-section-number">3.4.4.2</span> file</h4>
<ul>
<li><code>reaper --udp 127.0.0.1 file --filename /tmp/access.log</code> =&gt; write log entries to /tmp/access.log</li>
<li><code>reaper --udp 127.0.0.1 file --gzip --filename /tmp/access.log.gz</code> =&gt; write compressed log entries to /tmp/access.log.gz</li>
</ul>
<h4 id="rabbitmq"><span class="header-section-number">3.4.4.3</span> RabbitMQ</h4>
<p>Forward logs to a RabbitMQ exchange.</p>
<p><code>reaper --udp 127.0.0.1 rabbitmq --uri &quot;amqp://guest:guest@localhost:5672/&quot; --exchange exname --routing-key key --type direct</code></p>
<p>This will forward entries to a RabbitMQ broker, located at localhost:5672, using guest/guest as credentials, to the / virtual host, in the direct exchange exname, and with &quot;key&quot; as a routing key.</p>
<h4 id="stomp"><span class="header-section-number">3.4.4.4</span> STOMP</h4>
<p><code>./reaper_debug --udp 127.0.0.1:1514 stomp --login user --passcode password --host virtualhost --destination /queue/reaper --addr 192.168.1.2:61613</code></p>
<h4 id="elasticsearch"><span class="header-section-number">3.4.4.5</span> Elasticsearch</h4>
<p>Forward logs to an Elasticsearch server.</p>
<p><code>reaper --udp 127.0.0.1 elasticsearch --url http://127.0.0.1:9200 --index indexname</code></p>
<h4 id="redis"><span class="header-section-number">3.4.4.6</span> Redis</h4>
<p>Forward logs to Redis, using a redis list (think LPOP, RPUSH).</p>
<p><code>reaper --udp 127.0.0.1 redis --addr 127.0.0.1:6379 --listname thelistkey --database 6 --password pass</code></p>
<h4 id="kafka"><span class="header-section-number">3.4.4.7</span> Kafka</h4>
<p><code>reaper --udp 127.0.0.1 kafka --broker 192.168.1.2:9092 --broker 192.168.1.3:9092 --broker 192.168.1.4:9092 --topic topicname</code></p>
<h4 id="postgresqltimescaledb"><span class="header-section-number">3.4.4.8</span> PostgreSQL/TimescaleDB</h4>
<p>First you need to create a table in PostgreSQL that is consistent with the log format.</p>
<p>For example:</p>
<pre><code>+------------+--------------------------+-------------------+
| Column     | Type                     | Modifiers         | 
|------------+--------------------------+-------------------+
| timestamp  | timestamp with time zone |  not null         |
| method     | text                     |  default ''::text |
| scheme     | text                     |  default ''::text |
| host       | text                     |  default ''::text |
| server     | text                     |  default ''::text |
| uri        | text                     |  default ''::text |
| duration   | double precision         |  default 0        |
| length     | integer                  |  default 0        |
| status     | integer                  |  default 0        |
| sent       | integer                  |  default 0        |
| agent      | text                     |  default ''::text |
| remoteaddr | text                     |  default ''::text |
| remoteuser | text                     |  default ''::text |
+------------+--------------------------+-------------------+

Indexes:
    &quot;reaper_duration_timestamp_idx&quot; btree (duration, &quot;timestamp&quot; DESC)
    &quot;reaper_host_timestamp_idx&quot; btree (host, &quot;timestamp&quot; DESC)
    &quot;reaper_length_timestamp_idx&quot; btree (length, &quot;timestamp&quot; DESC)
    &quot;reaper_method_timestamp_idx&quot; btree (method, &quot;timestamp&quot; DESC)
    &quot;reaper_remoteaddr_timestamp_idx&quot; btree (remoteaddr, &quot;timestamp&quot; DESC)
    &quot;reaper_scheme_timestamp_idx&quot; btree (scheme, &quot;timestamp&quot; DESC)
    &quot;reaper_sent_timestamp_idx&quot; btree (sent, &quot;timestamp&quot; DESC)
    &quot;reaper_server_timestamp_idx&quot; btree (server, &quot;timestamp&quot; DESC)
    &quot;reaper_timestamp_idx&quot; btree (&quot;timestamp&quot; DESC)</code></pre>
<p>Then:</p>
<pre><code>reaper --udp 127.0.0.1:1514 pgsql \
    --uri &quot;postgres://user:password@127.0.0.1/dbname&quot;
    --table tablename
    --fields &quot;timestamp,method,scheme,host,server,uri,duration,length,status,sent,agent,remoteaddr,remoteuser&quot;    </code></pre>
<h4 id="external-nsqd"><span class="header-section-number">3.4.4.9</span> External nsqd</h4>
<p><code>reaper --udp 127.0.0.1:1514 nsq --addr 192.168.1.2:4150 --topic topicname --json</code></p>
<h4 id="forward-to-another-reaper-instance"><span class="header-section-number">3.4.4.10</span> Forward to another reaper instance</h4>
<p>On machine A 192.168.1.2 (with web server):</p>
<p><code>reaper --udp 127.0.0.1:1514 nsq --addr 192.168.1.3:4150 --topic embedded</code></p>
<p>On machine B 192.168.1.3:</p>
<p><code>reaper --nsqd-address 192.168.1.3 --nsqd-tcp-port 4150 pgsql ...</code></p>
<h3 id="http-api"><span class="header-section-number">3.4.5</span> HTTP API</h3>
<p>If started with <code>--http-address</code>, reaper exposes a HTTP API.</p>
<p>Endpoints:</p>
<ul>
<li>/status =&gt; just returns 200 HTTP status code.</li>
<li><p>/metrics =&gt; prometheus metrics (with the embedded nsqd metrics).</p></li>
<li><p>POST /download/:clientid?wait=3000&amp;size=1000 =&gt; creates a channel of access logs entries and download entries.</p>
<p>size is the number of entries to be returned. wait is the number of milliseconds to wait</p>
<p>After the first POST call, a nsq channel is created. All received entries will be copied to this channel. Each successive POST call with return different entries.</p></li>
<li><p>DELETE /download/:clientid =&gt; delete a previously created channel</p></li>
</ul>
<h3 id="websocket-api"><span class="header-section-number">3.4.6</span> Websocket API</h3>
<p>If started with <code>--websocket-address</code>, reaper exposes a websocket endpoint.</p>
<ul>
<li>/stream: stream received entries to the websocket client.</li>
</ul>
<h3 id="logging"><span class="header-section-number">3.4.7</span> Logging</h3>
<p>By default reaper own logs are written on stderr.</p>
<p>The logging level can be set with <code>--loglevel</code> [debug, info, warn, error, crit].</p>
<p>Alternatively reaper can use syslog with <code>--syslog</code></p>
<h1 id="design"><span class="header-section-number">4</span> Design</h1>
<p>reaper embeds a nsqd service (https://nsq.io). When access logs entries are received on TCP, UDP or stdin, they are first stored in the embedded nsqd. Thus, reaper only deletes an access log entry when it has been reliably sent to the configured destination.</p>
<p>Forwarding to the destination is done asynchronously to achieve good performance.</p>
<h1 id="changelog"><span class="header-section-number">5</span> Changelog</h1>
<p>https://github.com/stephane-martin/reaper/blob/master/CHANGELOG.md</p>
</article>
</body>
</html>
